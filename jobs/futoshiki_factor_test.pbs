#!/bin/bash

# PBS script for Futoshiki Task Factor performance testing
#PBS -N futoshiki_factor_test
#PBS -q short_cpuQ
#PBS -l walltime=06:00:00
# We request a good number of CPUs on a single node for the test
#PBS -l select=16:ncpus=16:mem=8gb
#PBS -l place=excl

# This script expects PUZZLE_FILE to be passed from the environment
if [ -z "$PUZZLE_FILE" ]; then
    echo "ERROR: PUZZLE_FILE environment variable not set."
    echo "Please submit this job using a wrapper or 'qsub -v PUZZLE_FILE=...'"
    exit 1
fi

# Change to submission directory
cd $PBS_O_WORKDIR

# Load modules
module load openmpi-4.0.4
module load mpich-3.2

# Build all versions (ensure they are up-to-date with the -f flag)
echo "Building all versions..."
make clean
make all -j4
if [ $? -ne 0 ]; then
    echo "Build failed!"
    exit 1
fi

echo ""
echo "====================================="
echo "Futoshiki Task Factor Testing"
echo "====================================="
echo "Date: $(date)"
echo "Node: $(hostname)"
echo "Puzzle: $PUZZLE_FILE"
echo ""

# --- Experiment Parameters ---
# Use a fixed number of cores to isolate the 'factor' variable
OMP_THEADS_TO_TEST=16
MPI_PROCS_TO_TEST=16

# The list of factors to sweep through
FACTORS_TO_TEST="0.5 1.0 2.0 4.0 8.0 16.0 32.0 64.0"


# Function to run a single test and parse the time
run_test() {
    local impl=$1
    local nprocs=$2
    local factor=$3
    local puzzle=$4
    
    echo "--- Testing: $impl with N=$nprocs, Factor=$factor ---"
    
    # Use the `time` command with a format string to get just the real time
    # The output is sent to stderr, so we redirect it
    local TIMEFORMAT='%R'
    local elapsed_time
    
    # Run in quiet mode (-q) to keep logs clean
    case $impl in
        openmp)
            export OMP_NUM_THREADS=$nprocs
            elapsed_time=$( { time ./bin/futoshiki_omp "$puzzle" -n -q -f "$factor"; } 2>&1 )
            ;;
        mpi)
            elapsed_time=$( { time mpirun.actual -np "$nprocs" ./bin/futoshiki_mpi "$puzzle" -n -q -f "$factor"; } 2>&1 )
            ;;
    esac
    
    # Print results in a CSV-friendly format
    echo "$impl,$nprocs,$factor,$elapsed_time"
}

# --- OpenMP Factor Scaling Test ---
echo "============================================"
echo "OpenMP Task Factor Test (Threads = $OMP_THEADS_TO_TEST)"
echo "============================================"
echo "Implementation,Threads,Factor,Time(s)"
for factor in $FACTORS_TO_TEST; do
    run_test openmp $OMP_THEADS_TO_TEST "$factor" "$PUZZLE_FILE"
done
echo ""


# --- MPI Factor Scaling Test ---
echo "============================================"
echo "MPI Task Factor Test (Processes = $MPI_PROCS_TO_TEST)"
echo "============================================"
echo "Implementation,Processes,Factor,Time(s)"
for factor in $FACTORS_TO_TEST; do
    run_test mpi $MPI_PROCS_TO_TEST "$factor" "$PUZZLE_FILE"
done

echo "Factor testing completed at $(date)"